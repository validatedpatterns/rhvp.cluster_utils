---
- name: Announce prerequisite checks (host)
  ansible.builtin.shell: |
    printf "==> Checking prerequisites...\n" > /dev/tty

- name: Read global.pattern from values-global.yaml
  ansible.builtin.command: yq -r .global.pattern values-global.yaml
  args:
    chdir: "{{ pattern_dir }}"
  register: _yq_global_pattern
  failed_when: false

- name: Warn on pattern name mismatch
  ansible.builtin.shell: |
    printf "\nWARNING: folder directory is \"%s\" and global.pattern is set to \"%s\"\n" "{{ pattern_name }}" "{{ _yq_global_pattern.stdout | trim }}" > /dev/tty
    printf "this can create problems. Please make sure they are the same!\n\n" > /dev/tty
  when: (pattern_name | trim) != (_yq_global_pattern.stdout | default("") | trim)

- name: Detect whether we are running inside a container
  ansible.builtin.stat:
    path: /run/.containerenv
  register: _containerenv

- name: Host validations (prerequisites on the local machine)
  when: not _containerenv.stat.exists
  block:
    - name: Check python-kubernetes (host)
      ansible.builtin.shell: |
        printf "    Looking for python-kubernetes module... " > /dev/tty
        if {{ (ansible_python_interpreter | default('/usr/bin/python3')) }} -c 'import kubernetes' >/dev/null 2>&1; then
          printf "OK\n" > /dev/tty
        else
          printf "Not found\n" > /dev/tty
          exit 1
        fi

    - name: Check kubernetes.core collection (host)
      ansible.builtin.shell: |
        printf "    Looking for kubernetes.core collection... " > /dev/tty
        if ansible-galaxy collection list | grep -q 'kubernetes.core'; then
          printf "OK\n" > /dev/tty
        else
          printf "Not found\n" > /dev/tty
          exit 1
        fi

- name: Container validations
  when: _containerenv.stat.exists
  block:
    - name: Check multiSourceConfig (container)
      ansible.builtin.command: yq -r '.main.multiSourceConfig.enabled // (.main.multiSourceConfig.enabled = "false")' values-global.yaml
      args:
        chdir: "{{ pattern_dir }}"
      register: _yq_msc_enabled
      failed_when: false

    - name: Enforce multiSourceConfig is enabled (container)
      ansible.builtin.shell: |
        printf "You must set \".main.multiSourceConfig.enabled: true\" in 'values-global.yaml'.\n" > /dev/tty
        exit 1
      when: (_yq_msc_enabled.stdout | default("") | trim | lower) != "true"
