---
- name: Announce prerequisite checks (host)
  ansible.builtin.shell: |
    printf "==> Checking prerequisites...\n" > /dev/tty

- name: Extract global.pattern
  ansible.builtin.set_fact:
    _global_pattern: "{{ values_global.global.pattern | default('') | string | trim }}"

- name: Warn on pattern name mismatch
  ansible.builtin.shell: |
    printf "\nWARNING: folder directory is \"%s\" and global.pattern is set to \"%s\"\n" "{{ pattern_name }}" "{{ _global_pattern }}"
    printf "this can create problems. Please make sure they are the same!\n\n"
  when: (pattern_name | string | trim) != _global_pattern

- name: Detect whether we are running inside a container
  ansible.builtin.stat:
    path: /run/.containerenv
  register: _containerenv

- name: Host validations (prerequisites on the local machine)
  when: not _containerenv.stat.exists
  block:
    - name: Check python-kubernetes (host)
      ansible.builtin.shell: |
        printf "    Looking for python-kubernetes module... " > /dev/tty
        if {{ (ansible_python_interpreter | default('/usr/bin/python3')) }} -c 'import kubernetes' >/dev/null 2>&1; then
          printf "OK\n" > /dev/tty
        else
          printf "Not found\n" > /dev/tty
          exit 1
        fi

    - name: Check kubernetes.core collection (host)
      ansible.builtin.shell: |
        set -o pipefail
        printf "    Looking for kubernetes.core collection... " > /dev/tty
        if ansible-galaxy collection list | grep -q 'kubernetes.core'; then
          printf "OK\n" > /dev/tty
        else
          printf "Not found\n" > /dev/tty
          exit 1
        fi

- name: Container validations
  when: _containerenv.stat.exists
  block:
    - name: Compute multiSourceConfig.enabled (default false)
      ansible.builtin.set_fact:
        _msc_enabled: "{{ values_global.main.multiSourceConfig.enabled | default(false) | bool }}"

    - name: Enforce multiSourceConfig is enabled (container)
      ansible.builtin.shell: |
        printf "You must set \".main.multiSourceConfig.enabled: true\" in 'values-global.yaml'.\n" > /dev/tty
        exit 1
      when: not _msc_enabled
