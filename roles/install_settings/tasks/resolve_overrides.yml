- name: Resolve pattern_install_chart
  ansible.builtin.set_fact:
    pattern_install_chart: >-
      {{
        pattern_install_chart
          | default(lookup("env", "PATTERN_INSTALL_CHART"), true)
          | default("oci://quay.io/validatedpatterns/pattern-install", true)
          | trim
      }}

- name: Resolve target_branch
  block:
    - name: Check CLI/env for target_branch override
      ansible.builtin.set_fact:
        target_branch: >-
          {{
            target_branch
              | default(lookup("env", "TARGET_BRANCH"), true)
              | default("", false)
              | trim
          }}

    - name: Derive target_branch via git (when not overridden)
      ansible.builtin.command: "git branch --show-current"  # noqa: command-instead-of-module
      args:
        chdir: "{{ pattern_dir }}"
      register: _br
      when: target_branch == ""
      failed_when: false

    - name: Set target_branch using git
      ansible.builtin.set_fact:
        target_branch: "{{ _br.stdout | trim }}"
      when: target_branch == "" and _br.rc == 0

    - name: Ensure target_branch is set
      ansible.builtin.assert:
        that: target_branch != ""
        fail_msg: |
          Could not determine target branch in '{{ pattern_dir }}'.
          Ensure that you are on a git branch or pass explicitly via
          the 'target_branch' variable or 'TARGET_BRANCH' environment variable.

- name: Resolve target_origin
  block:
    - name: Check CLI/env for target_origin override
      ansible.builtin.set_fact:
        target_origin: >-
          {{
            target_origin
              | default(lookup("env", "TARGET_ORIGIN"), true)
              | default("", false)
              | trim
          }}

    - name: Derive target_origin via git (when not overridden)
      ansible.builtin.command: "git config branch.{{ target_branch }}.remote"  # noqa: command-instead-of-module
      args:
        chdir: "{{ pattern_dir }}"
      register: _origin
      when: target_origin == ""
      failed_when: false

    - name: Set target_origin using git
      ansible.builtin.set_fact:
        target_origin: "{{ _origin.stdout | trim }}"
      when: target_origin == "" and _origin is not failed

    - name: Ensure target_origin is set
      ansible.builtin.assert:
        that: target_origin != ""
        fail_msg: |
          Could not determine target origin for branch '{{ target_branch }}' in '{{ pattern_dir }}'.
          Ensure branch '{{ target_branch }}' has a remote configured or pass explicitly via
          the 'target_origin' variable or 'TARGET_ORIGIN' environment variable.

- name: Resolve target_clustergroup
  ansible.builtin.set_fact:
    target_clustergroup: >-
      {{
        target_clustergroup
          | default(lookup("env", "TARGET_CLUSTERGROUP"), true)
          | default(main_clustergroup, true)
          | trim
      }}

- name: Resolve token_secret
  ansible.builtin.set_fact:
    token_secret: >-
      {{
        token_secret
          | default(lookup("env", "TOKEN_SECRET"), true)
          | default("", false)
          | trim
      }}

- name: Resolve token_namespace
  ansible.builtin.set_fact:
    token_namespace: >-
      {{
        token_namespace
          | default(lookup("env", "TOKEN_NAMESPACE"), true)
          | default("", false)
          | trim
      }}

- name: Resolve extra_helm_opts
  ansible.builtin.set_fact:
    extra_helm_opts: >-
      {{
        extra_helm_opts
          | default(lookup("env", "EXTRA_HELM_OPTS"), true)
          | default("", false)
          | trim
      }}

- name: Resolve uuid_helm_opts (from UUID_FILE)
  block:
    - name: Seed UUID file path
      ansible.builtin.set_fact:
        _uuid_file_path: >-
          {{
            uuid_file
              | default(lookup('env','UUID_FILE'), true)
              | default((lookup('env','HOME') | default('')) ~ '/.config/validated-patterns/pattern-uuid', true)
              | trim
          }}

    - name: Stat UUID file
      ansible.builtin.stat:
        path: "{{ _uuid_file_path }}"
      register: _uuid_stat

    - name: Read UUID (if file exists)
      ansible.builtin.slurp:
        path: "{{ _uuid_file_path }}"
      register: _uuid_slurp
      when: _uuid_stat.stat.exists

    - name: Compute uuid_helm_opts
      ansible.builtin.set_fact:
        uuid_helm_opts: >-
          {{
            '' if not _uuid_stat.stat.exists
            else '--set main.analyticsUUID=' ~ (_uuid_slurp.content | b64decode | trim)
          }}
