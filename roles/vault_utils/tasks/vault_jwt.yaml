---
- name: Check vault auth configuration
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: vault auth list -format=json
  register: vault_auth_json
  until: "'rc' in vault_auth_json"
  retries: 20
  delay: 45
  changed_when: false
  failed_when: "'stdout_lines' not in vault_auth_json"

- name: Set vault auth output json fact
  ansible.builtin.set_fact:
    vault_auth: "{{ vault_auth_json.stdout | from_json }}"
  when: vault_auth_json.stdout_lines | length > 0

- name: Set vault auth jwt fact
  ansible.builtin.set_fact:
    vault_auth_jwt: "{{ true if 'jwt/' in vault_auth else false }}"
  when: vault_auth | length > 0

- name: Enable jwt auth
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: vault auth enable jwt
  when: not vault_auth_jwt

- name: Split url into host and port
  ansible.builtin.set_fact:
    oidc_discovery_host: "{{ oidc_discovery_url | urlsplit('hostname') }}"
    oidc_discovery_port: "{{ '443' if oidc_discovery_url | urlsplit('port') == '' else oidc_discovery_url | urlsplit('port') }}"

- name: Get OIDC discovery certificate
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      bash -e -c
      "echo -n | openssl s_client -connect {{ oidc_discovery_host }}:{{ oidc_discovery_port }} -servername {{ oidc_discovery_host }}
      | openssl x509 -outform PEM > /tmp/oidc-discovery-certificate.pem"
  when: not vault_auth_jwt

- name: Write JWT configuration
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      vault write auth/jwt/config
        oidc_discovery_url={{ oidc_discovery_url }}
        default_role={{ default_role | default('default') }}
        oidc_discovery_ca_pem=@/tmp/oidc-discovery-certificate.pem
  when: not vault_auth_jwt

- name: Write JWT role
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      vault write auth/jwt/role/{{ default_role | default('default') }}
        role_type=jwt
        user_claim=sub
        bound_audiences={{ spiffe_audience }}
        bound_subject={{ spiffe_subject }}
        token_ttl={{ token_ttl | default('24h') }}
        token_policies={{ role_policy | default('{}-secret'.format(vault_global_policy)) }}
  when: not vault_auth_jwt

- name: Delete router CA certificate
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: rm -f /tmp/oidc-discovery-certificate.pem
  when: not vault_auth_jwt