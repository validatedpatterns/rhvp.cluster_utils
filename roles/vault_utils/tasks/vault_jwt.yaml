---
- name: Check vault auth configuration
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: vault auth list -format=json
  register: vault_auth_json
  until: "'rc' in vault_auth_json"
  retries: 20
  delay: 45
  changed_when: false
  failed_when: "'stdout_lines' not in vault_auth_json or vault_auth_json.stdout_lines | length == 0"

- name: Set vault auth output json fact
  ansible.builtin.set_fact:
    vault_auth: "{{ vault_auth_json.stdout | from_json }}"
  when: vault_auth_json.stdout_lines | length > 0

- name: Set vault auth jwt fact
  ansible.builtin.set_fact:
    vault_auth_jwt: "{{ true if 'jwt/' in vault_auth else false }}"
  when: vault_auth | length > 0

- name: Enable jwt auth
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: vault auth enable jwt
  when: not vault_auth_jwt

- name: Split url into host and port
  ansible.builtin.set_fact:
    oidc_discovery_host: "{{ oidc_discovery_url | urlsplit('hostname') }}"
    oidc_discovery_port: "{{ oidc_discovery_url | urlsplit('port') | default('443', true) }}"

- name: Check if OIDC endpoint is reachable
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      curl -fsk -o /dev/null -w "%{http_code}" {{ oidc_discovery_url }}/.well-known/openid-configuration
  register: oidc_discovery_reachable
  until: oidc_discovery_reachable.rc == 0 and oidc_discovery_reachable.stdout | int == 200
  retries: 20
  delay: 45
  changed_when: false
  failed_when: oidc_discovery_reachable.rc != 0 or oidc_discovery_reachable.stdout | int != 200

- name: Check JWT discovery configuration
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      vault read auth/jwt/config -format=json
  register: jwt_discovery_config_json
  changed_when: false
  failed_when: false

- name: Set jwt_discovery fact
  ansible.builtin.set_fact:
    jwt_discovery: "{{ true if jwt_discovery_config_json.stdout_lines | length > 0 else false }}"

- name: Set JWT discovery configuration fact
  ansible.builtin.set_fact:
    jwt_discovery_config: "{{ jwt_discovery_config_json.stdout | from_json }}"
  when: jwt_discovery

- name: Set JWT discovery configuration facts
  ansible.builtin.set_fact:
    jwt_config_oidc_discovery_url: "{{ jwt_discovery_config.data.oidc_discovery_url }}"
    jwt_config_default_role: "{{ jwt_discovery_config.data.default_role }}"
  when: jwt_discovery

- name: Get OIDC discovery certificate
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      bash -e -c
      "echo -n | openssl s_client -connect {{ oidc_discovery_host }}:{{ oidc_discovery_port }} -servername {{ oidc_discovery_host }}
      | openssl x509 -outform PEM > /tmp/oidc-discovery-certificate.pem"
  retries: 10
  delay: 30
  when: not vault_auth_jwt or
        not jwt_discovery or
        not jwt_config_oidc_discovery_url == oidc_discovery_url or
        not jwt_config_default_role == default_role | default('default')

- name: Write JWT configuration
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      vault write auth/jwt/config
        oidc_discovery_url={{ oidc_discovery_url }}
        default_role={{ default_role | default('default') }}
        oidc_discovery_ca_pem=@/tmp/oidc-discovery-certificate.pem
  retries: 10
  delay: 30
  when: not vault_auth_jwt or
        not jwt_discovery or
        not jwt_config_oidc_discovery_url == oidc_discovery_url or
        not jwt_config_default_role == default_role | default('default')

# Create JWT auth policies from vault_jwt_policies variable
# These are manually defined policies for SPIFFE workloads that need direct Vault access
- name: Write JWT policies directly to Vault
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      bash -e -c "echo '{{ item.policy | b64encode }}' | base64 -d | vault policy write {{ item.name }} -"
  loop: "{{ vault_jwt_policies | default([]) }}"
  loop_control:
    label: "Writing JWT policy {{ item.name }}"
  when: vault_jwt_policies is defined and vault_jwt_policies | length > 0

- name: Run JWT role tasks
  ansible.builtin.include_tasks: vault_jwt_roles.yaml
  loop: "{{ vault_jwt_roles | default([]) }}"
  loop_control:
    loop_var: jwt_role

- name: Delete router CA certificate
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: rm -f /tmp/oidc-discovery-certificate.pem
  when: not vault_auth_jwt
