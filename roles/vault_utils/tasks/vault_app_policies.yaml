---
# vault_app_policies.yaml
# Creates fine-grained Vault policies for application-level isolation
#
# This task file creates individual policies for each vaultPrefix provided.
# Each application gets its own policy that only allows access to its
# specific path, enabling application-level secret isolation.
#
# Required variables:
#   app_prefixes: List of app configs with 'prefix' key and optional 'jwt_role'
#                 e.g., [{prefix: "apps/qtodo"}, {prefix: "hub/infra/keycloak"}]
#
# Optional variables:
#   app_capabilities: Capabilities for app policies (default: read)
#   app_update_hub_role: Whether to update hub-role with new policies (default: true)
#   app_create_jwt_roles: Whether to create JWT roles per app (default: false)
#
# Example usage:
#   - name: Create app-specific vault policies
#     ansible.builtin.include_tasks:
#       file: vault_app_policies.yaml
#     vars:
#       app_prefixes:
#         - prefix: apps/qtodo
#           jwt_role:
#             service_account_names: "qtodo-sa"
#             service_account_namespaces: "qtodo"
#         - prefix: hub/infra/keycloak
#       app_update_hub_role: true

- name: Debug - Show app prefixes to process
  ansible.builtin.debug:
    msg: "Processing app prefixes: {{ app_prefixes }}"
    verbosity: 1
  when: app_prefixes is defined and app_prefixes | length > 0

- name: Skip if no app prefixes defined
  ansible.builtin.debug:
    msg: "No app_prefixes defined, skipping app policy creation"
    verbosity: 1
  when: app_prefixes is not defined or app_prefixes | length == 0

# Build list of policy names we need
- name: Build app policy names list
  ansible.builtin.set_fact:
    _app_policy_names: "{{ app_prefixes | map(attribute='prefix') | map('replace', '/', '-') | map('regex_replace', '$', '-k8s-secret') | list }}"
  when: app_prefixes is defined and app_prefixes | length > 0

# Get existing policies from Vault to check what needs to be created
- name: Get existing Vault policies
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: vault policy list -format=json
  register: _existing_policies_result
  changed_when: false
  when: app_prefixes is defined and app_prefixes | length > 0

- name: Parse existing policies
  ansible.builtin.set_fact:
    _existing_policies: "{{ _existing_policies_result.stdout | from_json }}"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - _existing_policies_result.rc == 0

# Filter to only policies that don't already exist
- name: Determine policies to create
  ansible.builtin.set_fact:
    _policies_to_create: "{{ _app_policy_names | difference(_existing_policies | default([])) }}"
  when: app_prefixes is defined and app_prefixes | length > 0

- name: Debug - Show policies to create
  ansible.builtin.debug:
    msg: "Policies to create: {{ _policies_to_create | default([]) }} (existing: {{ _existing_policies | default([]) }})"
    verbosity: 1
  when: app_prefixes is defined and app_prefixes | length > 0

# Create only policies that don't exist
- name: Configure app policy in Vault
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      bash -e -c "echo 'path \"secret/data/{{ _prefix }}/*\" { capabilities = [\"read\"] }' |
      vault policy write {{ _prefix | replace('/', '-') }}-k8s-secret -"
  loop: "{{ app_prefixes }}"
  loop_control:
    label: "Writing policy {{ _prefix | replace('/', '-') }}-k8s-secret"
  vars:
    _prefix: "{{ item.prefix }}"
    _policy_name: "{{ item.prefix | replace('/', '-') }}-k8s-secret"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - _policy_name in (_policies_to_create | default([]))

# Get current hub-role policies
- name: Get current hub-role policies
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      vault read -format=json auth/{{ vault_hub }}/role/{{ vault_hub }}-role
  register: _hub_role_result
  failed_when: false
  changed_when: false
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool

# Parse current policies and merge with new ones
- name: Set current policies fact
  ansible.builtin.set_fact:
    _current_policies: "{{ (_hub_role_result.stdout | from_json).data.token_policies | default(vault_hub_role_default_policies) }}"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool
    - _hub_role_result.rc == 0

- name: Set default policies if hub-role not found
  ansible.builtin.set_fact:
    _current_policies: "{{ vault_hub_role_default_policies }}"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool
    - _hub_role_result.rc != 0

# Merge current and new policies (removing duplicates)
- name: Merge policies
  ansible.builtin.set_fact:
    _merged_policies: "{{ (_current_policies + _app_policy_names) | unique }}"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool

# Check if hub-role policies need updating
- name: Check if hub-role policies changed
  ansible.builtin.set_fact:
    _hub_role_policies_changed: "{{ _current_policies | sort != _merged_policies | sort }}"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool

- name: Debug - Hub role policy change status
  ansible.builtin.debug:
    msg: "Hub role policies changed: {{ _hub_role_policies_changed }} (current: {{ _current_policies | sort }}, merged: {{ _merged_policies | sort }})"
    verbosity: 1
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool

# Update hub-role only if policies have changed
- name: Update hub-role with app policies
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      vault write auth/{{ vault_hub }}/role/{{ vault_hub }}-role
        bound_service_account_names="{{ active_external_secrets_sa | default('golang-external-secrets') }}"
        bound_service_account_namespaces="{{ active_external_secrets_ns | default('golang-external-secrets') }}"
        policies="{{ _merged_policies | join(',') }}"
        ttl="{{ vault_hub_ttl }}"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool
    - _hub_role_policies_changed | bool

- name: Display updated hub-role policies
  ansible.builtin.debug:
    msg: "hub-role policies updated to: {{ _merged_policies | join(', ') }}"
    verbosity: 1
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_update_hub_role | default(true) | bool
    - _hub_role_policies_changed | bool

# Optionally create JWT roles for app-level isolation
# Only creates roles for entries that have jwt_role defined
- name: Configure JWT role for app (if configured)
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_ns }}"
    pod: "{{ vault_pod }}"
    command: >
      vault write auth/"{{ vault_hub }}"/role/"{{ _app_name }}"-role
        bound_service_account_names="{{ item.jwt_role.service_account_names }}"
        bound_service_account_namespaces="{{ item.jwt_role.service_account_namespaces }}"
        policies="default,{{ vault_global_policy }}-secret,{{ item.prefix | replace('/', '-') }}-k8s-secret"
        ttl="{{ item.jwt_role.ttl | default(vault_hub_ttl) }}"
  loop: "{{ app_prefixes }}"
  loop_control:
    label: "Creating JWT role for {{ _app_name }}"
  vars:
    _app_name: "{{ item.prefix | basename }}"
  when:
    - app_prefixes is defined and app_prefixes | length > 0
    - app_create_jwt_roles | default(false) | bool
    - item.jwt_role is defined
