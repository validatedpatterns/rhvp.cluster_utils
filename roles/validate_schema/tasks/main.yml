---
- name: Find values-* files to validate
  ansible.builtin.find:
    paths: "{{ pattern_dir }}"
    patterns: "values-*.yaml"
    file_type: file
  register: _values_files

- name: Sort values files and determine clustergroup version cli arg
  ansible.builtin.set_fact:
    values_files_sorted: "{{ _values_files.files | map(attribute='path') | sort }}"
    clustergroup_version_cli: >-
      {{ ('--version ' + values_global.main.multiSourceConfig.clusterGroupChartVersion)
         if (values_global.main.multiSourceConfig.clusterGroupChartVersion | default('')) else '' }}

- name: Log files being validated
  ansible.builtin.debug:
    msg: "Validating clustergroup schema against: {{ values_files_sorted | map('basename') | join(', ') }}"

- name: Validate each file with helm template
  ansible.builtin.command: >-
    helm template {{ clustergroup_chart }} {{ clustergroup_version_cli }} {{ extra_helm_opts }} -f "{{ item }}"
  args:
    chdir: "{{ pattern_dir }}"
  register: helm_validate
  failed_when: false
  loop: "{{ values_files_sorted }}"
  loop_control:
    label: "{{ item | basename }}"

- name: Check validation results
  vars:
    failed_validations: "{{ helm_validate.results | selectattr('rc', 'ne', 0) | list }}"
  ansible.builtin.assert:
    that: failed_validations | length == 0
    fail_msg: |
      Schema validation failed for the following files:
      {% for error in failed_validations %}
      - {{ error.item | basename }} (RC: {{ error.rc }})
        Reproduction: cd {{ pattern_dir }} && helm template {{ clustergroup_chart }} {{ clustergroup_version_cli }} {{ extra_helm_opts }} -f "{{ error.item | basename }}"
        Error: {{ error.stderr }}
      {% endfor %}
    quiet: true
