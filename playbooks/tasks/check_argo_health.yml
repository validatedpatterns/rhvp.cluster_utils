---
- name: Get all Argo CD applications
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
  register: argo_apps

- name: Process Application Statuses
  ansible.builtin.set_fact:
    apps_summary: "{{ summary_yaml | from_yaml }}"
  vars:
    summary_yaml: |
      {% for item in argo_apps.resources -%}
      - namespace: {{ item.metadata.namespace }}
        name: {{ item.metadata.name }}
        sync: {{ item.status.sync.status | default('Unknown') }}
        health: {{ item.status.health.status | default('Unknown') }}
        bad: {{ (item.status.sync.status | default('Unknown') != 'Synced' or item.status.health.status | default('Unknown') != 'Healthy') | lower }}
      {% endfor %}

- name: Validate Cluster Health
  vars:
    bad_apps: "{{ apps_summary | selectattr('bad') | list }}"
  ansible.builtin.assert:
    that: bad_apps | length == 0
    fail_msg: |
      The following ArgoCD applications are out-of-sync or unhealthy:
      {% for app in bad_apps %}
      - {{ app.namespace }}/{{ app.name }} (Sync: {{ app.sync }}, Health: {{ app.health }})
      {% endfor %}
    quiet: true
